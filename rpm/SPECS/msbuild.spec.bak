%global debug_package %{nil}

%define libdir /usr/lib

Name:           msbuild
Version:        15.3.409.57025
Release:        1%{?dist}
Summary:        The Microsoft Build Engine is a platform for building applications.

License:        MIT
URL:            https://github.com/Microsoft/msbuild
Source0:        msbuild-%{version}.tar.gz
Source1:	msbuild.sh
Patch0:		use-local-sources.patch

BuildRequires:  mono-core > 5.4
#BuildRequires:  dotnetcore

%description
The Microsoft Build Engine, which is also known as MSBuild, provides an XML schema for a project file that controls how the build platform processes and builds software. Visual Studio uses MSBuild, but MSBuild does not depend on Visual Studio. By invoking msbuild.exe on your project or solution file, you can orchestrate and build products in environments where Visual Studio isn't installed.

%prep
%setup -q -n msbuild-%{version}
%patch0 -p1

#sed -i "s!--legacy-packages-directory!!g" dir.props
#sed -i "s!ubuntu.16.04!rhel.7!g" targets/runtimeDependencies/project.json

#sed -i "s!microsoft.net.compilers!Microsoft.Net.Compilers!g" cibuild.sh
#sed -i "s!ubuntu.14.04!rhel.7!g" cibuild.sh

#sed -i "s!--legacy-packages-directory!!g" init-tools.sh
#sed -i "s!__DOTNET_PATH=\$__TOOLRUNTIME_DIR/dotnetcli!__DOTNET_PATH=/usr/bin!g" init-tools.sh
#sed -i "s!rm -rf -- \$__TOOLRUNTIME_DIR;!mkdir -p Tools;!g" init-tools.sh
#sed -i "s!cd \$__scriptpath!cd \$__scriptpath\nelse\nmkdir -p \$__TOOLRUNTIME_DIR/dotnetcli; ln -s \$__DOTNET_PATH/dotnet \$__TOOLRUNTIME_DIR/dotnetcli/dotnet!g" init-tools.sh

#sed -i "s!portable!pdbonly!g" ../sdk/1.0.1/Sdks/Microsoft.NET.Sdk/build/Microsoft.NET.Sdk.props

mkdir -p Tools

%build
#export __PUBLISH_RID="rhel.7-x64"
#export RuntimeIdentifier="fedora.25-x64"
export __DOTNET_PATH="/usr/bin"
./cibuild.sh --host Mono --target Mono || exit -1

%install

mkdir -p %{buildroot}%{_bindir}
cp %{SOURCE1} %{buildroot}%{_bindir}/msbuild
cp %{SOURCE1} %{buildroot}%{_bindir}/MSBuild

mkdir -p %{buildroot}%{libdir}/mono/xbuild
cp -rf bin/Debug-MONO/Unix_Deployment/* %{buildroot}%{libdir}/mono/xbuild/
cp -rf ../sdk/1.0.1/Sdks %{buildroot}%{libdir}/mono/xbuild/
cp -rf ../sdk/1.0.1/15.0 %{buildroot}%{libdir}/mono/xbuild/


%files
%attr(0775,root,root) %{_bindir}/msbuild
%attr(0775,root,root) %{_bindir}/MSBuild
%dir %{libdir}/mono/xbuild
%{libdir}/mono/xbuild/*

%changelog
* Mon Apr 03 2017 Mikkel Kruse Johnsen <mikkel@xmedicus.com> - 15.2.0.0-1
- initial package for msbuild

